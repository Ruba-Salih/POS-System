{% extends "base.html" %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/pos.css' %}">
{% endblock %}

{% block content %}


<h3>ğŸ§¾ Ø·Ù„Ø¨ Ø±Ù‚Ù… {{ ticket.id }}</h3>
<p>ğŸ‘¤ Ø§Ù„ÙƒØ§Ø´ÙŠØ±: {{ ticket.cashier.full_name }}</p>

<hr>

<h4 class="mb-3">ğŸ›’ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</h4>

<div class="products-slider">
{% for product in products %}
    <form class="product-form" method="POST">
        {% csrf_token %}
        <input type="hidden" name="product" value="{{ product.id }}">
        <input type="hidden" name="quantity" value="1">

        <button type="submit" class="product-card">
            <div class="product-image">
                {% if product.image %}
                    <img src="{{ product.image.url }}">
                {% else %}
                    <div class="no-image">ğŸ“¦</div>
                {% endif %}
            </div>

            <div class="product-name">{{ product.name }}</div>
            <div class="product-price">{{ product.price }}</div>
        </button>
    </form>
{% endfor %}
</div>

<!-- CURRENT ORDER -->
<table class="table table-bordered align-middle">
<tr>
    <th>Ø§Ù„Ù…Ù†ØªØ¬</th>
    <th>Ø§Ù„ÙƒÙ…ÙŠØ©</th>
    <th>Ø§Ù„Ø³Ø¹Ø±</th>
    <th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
    <th>Ø­Ø°Ù</th>
</tr>

{% for item in ticket.items.all %}
<tr>
    <td>{{ item.product.name }}</td>

    <!-- EDIT QUANTITY (NO PIN REQUIRED) -->
    <td>
    <input type="number"
           value="{{ item.quantity }}"
           min="1"
           class="form-control form-control-sm qty-input"
           data-item-id="{{ item.id }}"
           style="width:70px;">
</td>

    <td>{{ item.price }}</td>
    <td id="item-subtotal-{{ item.id }}">
    {{ item.subtotal }}
</td>


    <!-- DELETE (MANAGER PIN REQUIRED) -->
    <td>
        <form method="POST"
              action="{% url 'sales:delete_ticket_item' item.id %}"
              onsubmit="return askPin(this);">
            {% csrf_token %}
            <input type="hidden" name="manager_pin">
            <button class="btn btn-danger btn-sm">ğŸ—‘ï¸Ø­Ø°Ù</button>
        </form>
    </td>
</tr>
{% empty %}
<tr>
    <td colspan="5" class="text-center">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù†Ø§ØµØ±</td>
</tr>
{% endfor %}
</table>

<h4 class="text-end">
    ğŸ’° Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: <span id="ticket-total">{{ ticket.total_amount }}</span>
</h4>

<hr>

<!-- PAYMENT -->
<form id="payment-form">
    {% csrf_token %}
    <select name="payment_method" required>
        <option value="cash">Ù†Ù‚Ø¯Ø§Ù‹</option>
        <option value="transfer">ØªØ­ÙˆÙŠÙ„</option>
    </select>

    <input type="text" name="transfer_number">

    <button class="btn btn-primary w-100 mt-2">
        âœ” Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø·Ù„Ø¨
    </button>
</form>

<script>
document.getElementById('payment-form').addEventListener('submit', function(e) {
    e.preventDefault();

    fetch("{% url 'sales:close_ticket' ticket.id %}", {
        method: "POST",
        headers: {
            "X-CSRFToken": "{{ csrf_token }}"
        },
        body: new FormData(this)
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            printTicket(data.ticket_id);
            window.location.href = "{% url 'sales:pos' %}";
        }
    });
});
</script>


<script>
function askPin(form) {
    const pin = prompt("Ø£Ø¯Ø®Ù„ Ø±Ù…Ø² Ø§Ù„Ù…Ø¯ÙŠØ±:");
    if (!pin) return false;
    form.querySelector('input[name="manager_pin"]').value = pin;
    return true;
}
</script>

<script>
document.querySelectorAll('.qty-input').forEach(input => {
    input.addEventListener('change', function () {
        const itemId = this.dataset.itemId;
        const quantity = this.value;

        fetch(`/sales/item/update/${itemId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: `quantity=${quantity}`
        })
        .then(res => res.json())
        .then(data => {
            if (data.error) return;

            document.getElementById(`item-subtotal-${itemId}`)
                .innerText = data.item_subtotal.toFixed(2);

            document.getElementById('ticket-total')
                .innerText = data.ticket_total.toFixed(2);
        });
    });
});
</script>

<script>
function printTicket(ticketId) {
    const iframe = document.createElement('iframe');
    iframe.style.display = 'none';
    iframe.src = `/sales/ticket/${ticketId}/print/`;
    document.body.appendChild(iframe);

    setTimeout(() => {
        document.body.removeChild(iframe);
    }, 3000);
}
</script>


{% endblock %}
