{% extends "base.html" %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/pos.css' %}">
{% endblock %}

{% block content %}
<div id="pos-root" data-ticket-id="{{ ticket.id|default:'' }}"></div>

<!-- HEADER -->
{% if ticket %}
<div class="d-flex justify-content-between align-items-center mb-2">
    <h3>ğŸ§¾ REF: {{ ticket.ref }}</h3>

    <a href="{% url 'sales:create_ticket' %}"
       target="_blank"
       rel="noopener"
       class="btn btn-success">
        â• Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯
    </a>
</div>

<p>ğŸ‘¤ Ø§Ù„ÙƒØ§Ø´ÙŠØ±: {{ ticket.cashier.full_name }}</p>

<hr>
{% endif %}


<div class="pos-layout">

<div class="pos-products">
<!-- PRODUCTS -->

<h4 class="mb-3">ğŸ›’ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</h4>

<div class="products-slider">
{% for product in products %}
    <form method="POST" class="product-form">
        {% csrf_token %}
        <input type="hidden" name="product" value="{{ product.id }}">
        <input type="hidden" name="quantity" value="1">

        <button type="submit" class="product-card">
            <div class="product-image">
                {% if product.image %}
                    <img src="{{ product.image.url }}" alt="{{ product.name }}">
                {% else %}
                   <img src="{% static 'img/logo2.jpeg' %}" alt="logo" class="fallback-img">
                {% endif %}
            </div>

            <div class="product-name">{{ product.name }}</div>
            <div class="product-price">{{ product.price }}</div>
        </button>
    </form>
{% endfor %}
</div>

</div>

<div class="pos-order" data-ticket-section class="{% if not ticket %}d-none{% endif %}">
<!-- CURRENT ORDER -->
<table class="table table-bordered align-middle">
<thead>
<tr>
    <th>Ø§Ù„Ù…Ù†ØªØ¬</th>
    <th>Ø§Ù„ÙƒÙ…ÙŠØ©</th>
    <th>Ø§Ù„Ø³Ø¹Ø±</th>
    <th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
    <th>Ø­Ø°Ù</th>
</tr>
</thead>

<tbody id="ticket-items-body">
{% for item in ticket.items.all %}
<tr>
    <td>{{ item.product.name }}</td>

    <td>
        <input type="number"
               value="{{ item.quantity }}"
               min="1"
               class="form-control form-control-sm qty-input"
               data-item-id="{{ item.id }}">
    </td>

    <td>{{ item.price }}</td>

    <td id="item-subtotal-{{ item.id }}">
        {{ item.subtotal }}
    </td>

    <td>
        <form method="POST"
              action="{% url 'sales:delete_ticket_item' item.id %}"
              class="delete-item-form"
              data-item-id="{{ item.id }}">
            {% csrf_token %}
            
            <button type="submit" class="btn btn-danger btn-sm">ğŸ—‘ï¸Ø­Ø°Ù</button>
        </form>
    </td>
</tr>
{% empty %}
<tr id="empty-row">
    <td colspan="5" class="text-center">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù†Ø§ØµØ±</td>
</tr>

{% endfor %}
</tbody>
</table>

<h4 class="text-start">
    ğŸ’° Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:
    <span id="ticket-total">{{ ticket.total_amount }}</span>
</h4>

<hr>

<!-- PAYMENT -->
<form id="payment-form">
    {% csrf_token %}

    <select name="payment_method"
            id="payment-method"
            class="form-select mb-2"
            required>
        <option value="cash">Ù†Ù‚Ø¯Ø§Ù‹</option>
        <option value="transfer">ØªØ­ÙˆÙŠÙ„</option>
    </select>

    <input type="text"
           name="transfer_number"
           id="transfer-number"
           class="form-control mb-2 d-none"
           placeholder="Ø±Ù‚Ù… Ø§Ù„ØªØ­ÙˆÙŠÙ„">

    <button type="submit" class="btn btn-primary w-100">
        âœ” Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø·Ù„Ø¨
    </button>
</form>
</div>

</div>

</div>

<script>
const csrfToken = document.querySelector('meta[name="csrf-token"]')?.content;

const posRoot = document.getElementById('pos-root');

// BASE url (NO ID here)
const CLOSE_TICKET_BASE_URL = "/sales/ticket/";

function getTicketId() {
    return posRoot.dataset.ticketId;
}

function setTicketId(id) {
    posRoot.dataset.ticketId = id;
}

</script>

<script>
document.getElementById('payment-form').addEventListener('submit', function (e) {
    e.preventDefault();

    if (paymentMethod.value === 'transfer' && !transferInput.value.trim()) {
        alert('âš ï¸ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ù‚Ø¨Ù„ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø·Ù„Ø¨');
        return;
    }

    const ticketId = getTicketId();
    if (!ticketId) {
        alert('âŒ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø¨ Ù…ÙØªÙˆØ­');
        return;
    }

    fetch(`${CLOSE_TICKET_BASE_URL}${ticketId}/close/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrfToken,
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: new FormData(this)
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
           printTicket(data.ticket_id);
            setTicketId('');
            document.getElementById('ticket-total').innerText = '0.00';
            window.location.href = "{% url 'cashier_dashboard' %}";

        } else {
            alert('âŒ Ù„Ù… ÙŠØªÙ… Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø·Ù„Ø¨');
        }
    });
});
</script>

<script>
const paymentMethod = document.getElementById('payment-method');
const transferInput = document.getElementById('transfer-number');

paymentMethod.addEventListener('change', function () {
    if (this.value === 'transfer') {
        transferInput.classList.remove('d-none');
        transferInput.required = true;
    } else {
        transferInput.classList.add('d-none');
        transferInput.required = false;
        transferInput.value = '';
    }
});
</script>

<script>
document.querySelectorAll('.product-form').forEach(form => {
    form.addEventListener('submit', function (e) {
        e.preventDefault();

        fetch(window.location.pathname, {
            method: 'POST',
            headers: {
                'X-CSRFToken': this.querySelector('[name=csrfmiddlewaretoken]').value,
                'X-Requested-With': 'XMLHttpRequest',
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: new URLSearchParams(new FormData(this))
        })
        .then(res => res.json())
        .then(data => {

            /* ğŸ§  first product â†’ update URL */
            if (!getTicketId()) {
                setTicketId(data.ticket_id);
                history.replaceState({}, '', `/sales/pos/${data.ticket_id}/`);
            }

            /* show order + payment */
            document.querySelector('[data-ticket-section]').classList.remove('d-none');

            /* update total */
            document.getElementById('ticket-total').innerText =
                data.ticket_total.toFixed(2);

            /* âœ… ADD ROW */
            const tbody = document.getElementById('ticket-items-body');

            const emptyRow = document.getElementById('empty-row');
            if (emptyRow) {
                emptyRow.remove();
            }

            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${data.item.product}</td>
                <td>
                    <input type="number"
                           value="${data.item.quantity}"
                           min="1"
                           class="form-control form-control-sm qty-input"
                           data-item-id="${data.item.id}">
                </td>
                <td>${data.item.price}</td>
                <td id="item-subtotal-${data.item.id}">
                    ${data.item.subtotal.toFixed(2)}
                </td>
                <td>
                    <form method="POST"
                          action="/sales/item/delete/${data.item.id}/"
                          class="delete-item-form"
                          data-item-id="${data.item.id}">
            
                        <button class="btn btn-danger btn-sm">ğŸ—‘ï¸Ø­Ø°Ù</button>
                    </form>
                </td>
            `;

            tbody.appendChild(row);
        });
    });
});
</script>

<script>
document.addEventListener('change', function (e) {
    if (!e.target.classList.contains('qty-input')) return;

    const input = e.target;
    const itemId = input.dataset.itemId;

    fetch(`/sales/item/update/${itemId}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrfToken,
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: `quantity=${input.value}`
    })
    .then(res => res.json())
    .then(data => {
        if (data.error) return;

        // âœ… update item subtotal
        document.getElementById(`item-subtotal-${itemId}`)
            .innerText = data.item_subtotal.toFixed(2);

        // âœ… update ticket total
        document.getElementById('ticket-total')
            .innerText = data.ticket_total.toFixed(2);
    });
});
</script>

<div id="manager-pin-dialog" class="manager-pin-backdrop d-none">
    <div class="manager-pin-box">
        <h5 class="mb-2">ğŸ” Ø£Ø¯Ø®Ù„ Ø±Ù…Ø² Ø§Ù„Ù…Ø¯ÙŠØ±</h5>

        <input type="password"
               id="manager-pin-input"
               class="form-control mb-3"
               maxlength="6"
               autocomplete="off"
               inputmode="numeric">

        <div class="d-flex justify-content-end gap-2">
            <button type="button"
                    id="manager-pin-cancel"
                    class="btn btn-secondary btn-sm">
                Ø¥Ù„ØºØ§Ø¡
            </button>
            <button type="button"
                    id="manager-pin-confirm"
                    class="btn btn-primary btn-sm">
                ØªØ£ÙƒÙŠØ¯
            </button>
        </div>
    </div>
</div>
<script>
const pinDialog = document.getElementById('manager-pin-dialog');
const pinInput = document.getElementById('manager-pin-input');
const pinConfirmBtn = document.getElementById('manager-pin-confirm');
const pinCancelBtn = document.getElementById('manager-pin-cancel');

let deleteContext = null; // will store form + action when user clicks delete

document.addEventListener('click', function (e) {
    const btn = e.target.closest('.delete-item-form button');
    if (!btn) return;

    e.preventDefault();

    const form = btn.closest('.delete-item-form');

    // save context for later
    deleteContext = {
        form: form,
        actionUrl: form.action
    };

    // show dialog
    pinInput.value = '';
    pinDialog.classList.remove('d-none');
    pinInput.focus();
});

pinCancelBtn.addEventListener('click', function () {
    pinDialog.classList.add('d-none');
    pinInput.value = '';
    deleteContext = null;
});

pinConfirmBtn.addEventListener('click', function () {
    if (!deleteContext) return;

    const pin = pinInput.value.trim();
    if (!pin) {
        alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù…Ø² Ø§Ù„Ù…Ø¯ÙŠØ±');
        return;
    }

    const formData = new FormData();
    formData.append('manager_pin', pin);
    formData.append('csrfmiddlewaretoken', csrfToken);

    fetch(deleteContext.actionUrl, {
        method: 'POST',
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': csrfToken
        },
        body: formData
    })
    .then(res => res.json())
    .then(() => {
        // âœ… remove row
        const row = deleteContext.form.closest('tr');
        row.remove();

        // âœ… if no items left
        const tbody = document.getElementById('ticket-items-body');
        if (!tbody.querySelector('tr')) {
            tbody.innerHTML = `
                <tr id="empty-row">
                    <td colspan="5" class="text-center">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù†Ø§ØµØ±</td>
                </tr>
            `;
        }

        // hide dialog + reset
        pinDialog.classList.add('d-none');
        pinInput.value = '';
        deleteContext = null;
    })
    .catch(() => {
        alert('âŒ Ø±Ù…Ø² Ø§Ù„Ù…Ø¯ÙŠØ± ØºÙŠØ± ØµØ­ÙŠØ­');
    });
});
</script>

<script>
function printTicket(ticketId) {
    const url = `/sales/ticket/${ticketId}/print/`;

    const win = window.open(
        url,
        "_blank",
        "width=400,height=600,toolbar=0,menubar=0,scrollbars=0,resizable=0"
    );

    if (!win) {
        alert("Please allow popups to enable printing");
        return;
    }

    win.focus();

    win.onload = function () {
        win.print();

        // auto-close after print
        setTimeout(() => {
            win.close();
        }, 1000);
    };
}
</script>

{% endblock %}
